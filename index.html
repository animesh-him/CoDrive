<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CoDrive</title>
<style>
  /* Instagram animated gradient background */
  body {
    margin: 0;
    font-family: cursive;
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    animation: gradientBG 3s linear infinite alternate;
    background-size: 400% 400%;
    color: white;
  }
  @keyframes gradientBG {
    0% {background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366);}
    25% {background: linear-gradient(45deg, #bc1888, #9d36b8, #6a11cb, #2575fc);}
    50% {background: linear-gradient(45deg, #6a11cb, #2575fc, #f09433, #e6683c);}
    75% {background: linear-gradient(45deg, #dc2743, #cc2366, #bc1888, #9d36b8);}
    100% {background: linear-gradient(45deg, #2575fc, #f09433, #e6683c, #dc2743);}
  }
  h1 { font-size: 2em; margin-top: 20px; }
  .btn { padding: 8px 12px; margin: 5px; cursor: pointer; border: none; border-radius: 5px; }
  .btn-black { background: black; color: white; }
  .btn-gray { background: gray; color: black; }
  select { padding: 8px; margin: 5px; border-radius: 5px; border: none; background: black; color: white; font-size: 14px; }
  .dropdown-container { display: flex; flex-direction: column; width: 90%; max-width: 400px; margin: 5px 0; }
  .pop-bar { margin: 3px 0; height: 20px; border-radius: 5px; display: flex; align-items: center; justify-content: flex-end; padding-right: 5px; font-size: 12px; color: white; }
  .footer { margin-top: auto; text-align: center; font-size: 16px; }
</style>
</head>
<body>

<h1>CoDrive</h1>

<!-- Day selector -->
<div>
  <button id="todayBtn" class="btn btn-black">Today</button>
  <button id="tomorrowBtn" class="btn btn-black">Tomorrow</button>
</div>

<!-- Dropdowns -->
<div class="dropdown-container">
  <select id="fromLocation"></select>
  <select id="toLocation"></select>
  <select id="timeSlot">
    <option disabled selected>Time slot</option>
  </select>
</div>

<!-- My Preference Button -->
<button id="myPrefBtn" class="btn btn-gray">My Preference</button>

<!-- Popularity Bars -->
<div id="popularityContainer" style="width: 90%; max-width: 400px; margin-top:10px;"></div>

<!-- Footer -->
<div class="footer">
  <div>Finding my co-driving partner!</div>
  <div>Created by Animesh</div>
</div>

<script>
const workerURL = "https://codrive-api.animesh-him.workers.dev";

// Locations
const locations = [
  "Bagmane Tech Park, CV Raman Nagar",
  "Boeing Office (North Bangalore)",
  "Brigade Eldorado",
  "Cubbon Park",
  "Dynamatics (North Bangalore)",
  "Electronic City",
  "Ecospace (Bellandur)",
  "ITPL (Whitefield)",
  "KARLE SEZ",
  "Koramangala",
  "Kempegowda International Airport T1",
  "Kempegowda International Airport T2",
  "MG Road",
  "Manyata Tech Park",
  "Prestige Finsbury",
  "SAP Labs (North Bangalore)",
  "Shell Technology Center (North Bangalore)",
  "Sarjapur"
].sort();

// Elements
const fromSel = document.getElementById("fromLocation");
const toSel = document.getElementById("toLocation");
const timeSel = document.getElementById("timeSlot");
const popContainer = document.getElementById("popularityContainer");
const todayBtn = document.getElementById("todayBtn");
const tomorrowBtn = document.getElementById("tomorrowBtn");
const myPrefBtn = document.getElementById("myPrefBtn");

let selectedDay = "today";
let selectedFrom = "";
let selectedTo = "";
let selectedTime = "";

// Populate locations
function populateLocations() {
  fromSel.innerHTML = '<option disabled selected>From location</option>';
  toSel.innerHTML = '<option disabled selected>To location</option>';
  locations.forEach(loc => {
    fromSel.innerHTML += `<option value="${loc}">${loc}</option>`;
    toSel.innerHTML += `<option value="${loc}">${loc}</option>`;
  });
}
populateLocations();

// Day button handlers
todayBtn.onclick = () => { selectedDay="today"; updateDayButtons(); fetchPopularity(); };
tomorrowBtn.onclick = () => { selectedDay="tomorrow"; updateDayButtons(); fetchPopularity(); };

function updateDayButtons(){
  todayBtn.style.background = (selectedDay==="today") ? "gray" : "black";
  todayBtn.style.color = (selectedDay==="today") ? "black" : "white";
  tomorrowBtn.style.background = (selectedDay==="tomorrow") ? "gray" : "black";
  tomorrowBtn.style.color = (selectedDay==="tomorrow") ? "black" : "white";
}

// Handle location selection
fromSel.onchange = () => { selectedFrom=fromSel.value; filterToOptions(); fetchPopularity(); };
toSel.onchange = () => { selectedTo=toSel.value; filterFromOptions(); fetchPopularity(); };

// Disable selected location from other dropdown
function filterToOptions(){
  for(let i=0;i<toSel.options.length;i++){
    toSel.options[i].disabled = (toSel.options[i].value === selectedFrom);
  }
}
function filterFromOptions(){
  for(let i=0;i<fromSel.options.length;i++){
    fromSel.options[i].disabled = (fromSel.options[i].value === selectedTo);
  }
}

// Populate time slots (future 30-min slots)
function populateTimeSlots(){
  timeSel.innerHTML = '<option disabled selected>Time slot</option>';
  const now = new Date();
  const istOffset = 5.5*60; // IST offset in minutes
  const nowUTC = new Date(now.getTime() + now.getTimezoneOffset()*60000);
  const nowIST = new Date(nowUTC.getTime() + istOffset*60000);
  let start = new Date(nowIST); start.setSeconds(0,0);
  for(let h=0; h<24; h++){
    for(let m=0; m<60; m+=30){
      const slotEnd = new Date(nowIST);
      slotEnd.setHours(h); slotEnd.setMinutes(m+30);
      if(slotEnd>nowIST){
        const sh = String(h).padStart(2,'0');
        const sm = String(m).padStart(2,'0');
        const eh = String(h).padStart(2,'0');
        const em = String(m+30).padStart(2,'0');
        const slot = `${sh}:${sm}-${eh}:${em}`;
        timeSel.innerHTML += `<option value="${slot}">${slot}</option>`;
      }
    }
  }
}
populateTimeSlots();

// Fetch popularity
async function fetchPopularity(){
  if(!selectedFrom || !selectedTo) return;
  const now = new Date();
  const istOffset = 5.5*60;
  const nowUTC = new Date(now.getTime() + now.getTimezoneOffset()*60000);
  const nowIST = new Date(nowUTC.getTime() + istOffset*60000);
  const dateStr = (selectedDay==="today") ? nowIST.toISOString().split('T')[0] : new Date(nowIST.getTime()+86400000).toISOString().split('T')[0];
  
  const slots = Array.from(timeSel.options).filter(o=>o.value!=='Time slot').map(o=>o.value);
  
  const res = await fetch(workerURL+"/popularity", {
    method:"POST",
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({date:dateStr, from:selectedFrom, to:selectedTo, slots})
  });
  const data = await res.json();
  
  // Display bars
  popContainer.innerHTML = '';
  slots.forEach(slot=>{
    const count = data[slot] || 0;
    let color = 'lightgray';
    if(count===1) color='lightgray';
    else if(count===2) color='gray';
    else if(count>=3) color='black';
    const div = document.createElement('div');
    div.className = 'pop-bar';
    div.style.background=color;
    div.textContent = slot + (count>0 ? ` (${count})` : '');
    popContainer.appendChild(div);
  });
}

// Handle preference
myPrefBtn.onclick = async ()=>{
  const slot = timeSel.value;
  if(!selectedFrom || !selectedTo || !slot || slot==="Time slot") return;
  const now = new Date();
  const istOffset = 5.5*60;
  const nowUTC = new Date(now.getTime() + now.getTimezoneOffset()*60000);
  const nowIST = new Date(nowUTC.getTime() + istOffset*60000);
  const dateStr = (selectedDay==="today") ? nowIST.toISOString().split('T')[0] : new Date(nowIST.getTime()+86400000).toISOString().split('T')[0];

  await fetch(workerURL+"/vote", {
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({date:dateStr, from:selectedFrom, to:selectedTo, slot})
  });
  fetchPopularity();
};

</script>
</body>
</html>
