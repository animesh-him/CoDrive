<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CoDrive</title>

<style>
:root{
  --grad: linear-gradient(270deg,#ff0066,#ff9900,#9933ff);
}
*{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont;}
body{
  margin:0;
  min-height:100vh;
  background:var(--grad);
  background-size:600% 600%;
  animation:bgMove 12s ease infinite;
  color:#fff;
}
@keyframes bgMove{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
.container{
  max-width:520px;
  margin:auto;
  padding:16px;
}
h1{
  text-align:center;
  font-family:cursive;
  margin-bottom:10px;
}
.tabs{
  display:flex;
  gap:8px;
  justify-content:center;
  margin-bottom:14px;
}
.tabs button{
  border:none;
  padding:8px 14px;
  border-radius:20px;
  cursor:pointer;
  background:rgba(255,255,255,0.25);
  color:#fff;
}
.tabs button.active{
  background:#fff;
  color:#000;
}
.card{
  background:rgba(0,0,0,0.25);
  border-radius:16px;
  padding:16px;
}
select,button{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:none;
  margin-top:10px;
  font-size:15px;
}
button{
  background:#fff;
  color:#000;
  font-weight:600;
  cursor:pointer;
}
.results{
  margin-top:16px;
}
.slot{
  display:flex;
  align-items:center;
  gap:10px;
  margin:6px 0;
}
.bar{
  height:10px;
  background:#fff;
  border-radius:6px;
  transition:width .4s ease;
}
.small{
  font-size:13px;
  opacity:.9;
}
.footer{
  text-align:center;
  margin-top:16px;
  font-family:cursive;
  opacity:.8;
}
</style>
</head>

<body>
<div class="container">
  <h1>CoDrive</h1>

  <div class="tabs" id="tabs"></div>

  <div class="card">
    <select id="from"></select>
    <select id="to"></select>
    <select id="time"></select>
    <button onclick="submitRoute()">Select Route</button>

    <div class="results" id="results"></div>
  </div>

  <div class="footer">Created by Animesh</div>
</div>

<script>
const API="https://codrive-api.animesh-him.workers.dev";
let currentDate="";

async function loadLocations(){
  const [f,t]=await Promise.all([
    fetch("from_locations.txt").then(r=>r.text()),
    fetch("to_locations.txt").then(r=>r.text())
  ]);
  fillSelect("from",f);
  fillSelect("to",t);
}

function fillSelect(id,text){
  const sel=document.getElementById(id);
  sel.innerHTML="";
  text.split(/[,;\n]/).map(v=>v.trim()).filter(Boolean).forEach(v=>{
    const o=document.createElement("option");
    o.value=o.textContent=v;
    sel.appendChild(o);
  });
}

function genDates(){
  const tabs=document.getElementById("tabs");
  tabs.innerHTML="";
  const today=new Date();
  const tomorrow=new Date(); tomorrow.setDate(today.getDate()+1);
  [
    {label:"Today",d:today},
    {label:"Tomorrow",d:tomorrow}
  ].forEach((obj,i)=>{
    const b=document.createElement("button");
    const val=obj.d.toISOString().slice(0,10);
    b.textContent=obj.label;
    b.onclick=()=>selectDate(val,b);
    if(i===0){b.classList.add("active");currentDate=val;}
    tabs.appendChild(b);
  });
}

function selectDate(val,btn){
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  currentDate=val;
  genTimes();
  refresh();
}

function genTimes(){
  const sel=document.getElementById("time");
  sel.innerHTML="";
  const now=new Date();
  const isToday=currentDate===now.toISOString().slice(0,10);

  for(let h=0;h<24;h++){
    for(let m=0;m<60;m+=15){
      const start=new Date(currentDate+"T"+String(h).padStart(2,"0")+":"+String(m).padStart(2,"0")+":00");
      const end=new Date(start.getTime()+15*60000);

      if(isToday && end < now) continue;

      const label=
        start.toTimeString().slice(0,5)+" - "+
        end.toTimeString().slice(0,5);

      const o=document.createElement("option");
      o.value=o.textContent=label;
      sel.appendChild(o);
    }
  }
}

async function submitRoute(){
  const body={
    date:currentDate,
    from:from.value,
    to:to.value,
    time:time.value
  };
  await fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(body)
  });
  refresh();
}

async function refresh(){
  const q=`?date=${currentDate}&from=${from.value}&to=${to.value}`;
  const data=await fetch(API+q).then(r=>r.json());
  const res=document.getElementById("results");
  res.innerHTML="<h3>Popularity</h3>";
  if(!data.length){res.innerHTML+="<div class='small'>No selections yet</div>";return;}
  const max=Math.max(...data.map(d=>d.count));
  data.forEach(d=>{
    const row=document.createElement("div");
    row.className="slot";
    const bar=document.createElement("div");
    bar.className="bar";
    bar.style.width=(d.count/max*100)+"%";
    bar.style.flex="1";
    row.innerHTML=`<div class="small">${d.time} (${d.count})</div>`;
    row.appendChild(bar);
    res.appendChild(row);
  });
}

setInterval(refresh,60000);

loadLocations();
genDates();
genTimes();
refresh();
</script>
</body>
</html>
