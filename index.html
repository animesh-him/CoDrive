<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CoDrive</title>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  color: #fff;
  min-height: 100vh;
  background: linear-gradient(270deg,#ff6ec4,#7873f5,#4adede,#ff6ec4);
  background-size: 800% 800%;
  animation: gradient 18s ease infinite;
}

@keyframes gradient {
  0% { background-position:0% 50% }
  50% { background-position:100% 50% }
  100% { background-position:0% 50% }
}

.container {
  max-width: 420px;
  margin: auto;
  padding: 16px;
}

select, button {
  width: 100%;
  padding: 12px;
  margin-top: 12px;
  border-radius: 8px;
  border: none;
  font-size: 16px;
}

button {
  background: #ffffff;
  color: #000;
  font-weight: 600;
}

button:disabled {
  opacity: 0.4;
}

.range-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 16px;
}

.bar {
  margin-top: 10px;
}

.bar-track {
  height: 12px;
  background: rgba(255,255,255,0.25);
  border-radius: 6px;
  overflow: hidden;
}

.bar-fill {
  height: 100%;
  background: #fff;
}

.footer {
  margin-top: 40px;
  text-align: center;
  font-size: 14px;
  opacity: 0.9;
}
</style>
</head>

<body>
<div class="container">

<h2>CoDrive</h2>

<select id="from">
  <option value="">From</option>
  <option value="eldorado">Eldorado</option>
  <option value="manyata">Manyata</option>
</select>

<select id="to">
  <option value="">To</option>
  <option value="eldorado">Eldorado</option>
  <option value="manyata">Manyata</option>
</select>

<button id="showBtn" style="display:none;">Show Popularity</button>

<div id="ranges" class="range-grid" style="display:none;"></div>
<div id="results"></div>

<select id="slotSelect" style="display:none;"></select>
<button id="voteBtn" style="display:none;">My Preference</button>

<div class="footer">
  <div>Find your co-driving partner today</div>
  <div>Created by Animesh</div>
</div>

</div>

<script>
const WORKER = "PASTE_YOUR_WORKER_URL_HERE";

const fromSel = document.getElementById("from");
const toSel = document.getElementById("to");
const showBtn = document.getElementById("showBtn");
const rangesDiv = document.getElementById("ranges");
const resultsDiv = document.getElementById("results");
const slotSelect = document.getElementById("slotSelect");
const voteBtn = document.getElementById("voteBtn");

let activeRangeStart = null;

const ranges = [
  { label:"00–06 hours", start:0 },
  { label:"06–12 hours", start:6 },
  { label:"12–18 hours", start:12 },
  { label:"18–24 hours", start:18 }
];

function istNow() {
  return new Date(new Date().toLocaleString("en-US",{ timeZone:"Asia/Kolkata" }));
}

function todayStr() {
  return istNow().toISOString().slice(0,10);
}

function rangeIsPast(start) {
  const now = istNow();
  const rangeEnd = new Date(now);
  rangeEnd.setHours(start + 6, 0, 0, 0);
  return now >= rangeEnd;
}

function slotsForRange(start) {
  const now = istNow();
  const slots = [];

  for (let h = start; h < start + 6; h++) {
    for (let m of [0,30]) {
      const slotTime = new Date(now);
      slotTime.setHours(h, m, 0, 0);
      if (slotTime > now) {
        const endH = m === 30 ? h + 1 : h;
        const endM = m === 30 ? "00" : "30";
        slots.push(
          `${String(h).padStart(2,"0")}:${m === 0 ? "00" : "30"}-` +
          `${String(endH).padStart(2,"0")}:${endM}`
        );
      }
    }
  }
  return slots;
}

fromSel.onchange = toSel.onchange = () => {
  showBtn.style.display = fromSel.value && toSel.value ? "block" : "none";
};

showBtn.onclick = () => {
  rangesDiv.innerHTML = "";
  rangesDiv.style.display = "grid";
  resultsDiv.innerHTML = "";
  slotSelect.style.display = "none";
  voteBtn.style.display = "none";

  ranges.forEach(r => {
    const btn = document.createElement("button");
    btn.textContent = r.label;
    btn.disabled = rangeIsPast(r.start);
    btn.onclick = () => loadPopularity(r.start);
    rangesDiv.appendChild(btn);
  });
};

async function loadPopularity(startHour) {
  activeRangeStart = startHour;

  const slots = slotsForRange(startHour);
  if (slots.length === 0) return;

  const res = await fetch(WORKER + "/popularity", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      date: todayStr(),
      from: fromSel.value,
      to: toSel.value,
      slots
    })
  });

  const data = await res.json();
  resultsDiv.innerHTML = "";
  slotSelect.innerHTML = "";

  const max = Math.max(1, ...Object.values(data));

  slots.forEach(s => {
    const count = data[s];
    const div = document.createElement("div");
    div.className = "bar";
    div.innerHTML = `
      <div>${s} (${count})</div>
      <div class="bar-track">
        <div class="bar-fill" style="width:${(count/max)*100}%"></div>
      </div>
    `;
    resultsDiv.appendChild(div);

    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    slotSelect.appendChild(opt);
  });

  slotSelect.style.display = "block";
  voteBtn.style.display = "block";
}

voteBtn.onclick = async () => {
  const slot = slotSelect.value;

  await fetch(WORKER + "/vote", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      date: todayStr(),
      from: fromSel.value,
      to: toSel.value,
      slot
    })
  });

  loadPopularity(activeRangeStart);
};
</script>
</body>
</html>
