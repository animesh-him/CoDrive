<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CoDrive</title>

<!-- Google cursive font -->
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">

<style>
body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  color: #fff;
  background: linear-gradient(
    270deg,
    #f58529,
    #dd2a7b,
    #8134af,
    #515bd4,
    #f58529
  );
  background-size: 1000% 1000%;
  animation: instaGradient 18s ease infinite;
}

@keyframes instaGradient {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.container {
  max-width: 420px;
  margin: auto;
  padding: 16px;
}

h1 {
  text-align: center;
  font-family: 'Pacifico', cursive;
  font-weight: normal;
}

select, button {
  width: 100%;
  padding: 12px;
  margin-top: 12px;
  border-radius: 10px;
  border: none;
  font-size: 16px;
}

button {
  background: #ffffff;
  color: #000;
  font-weight: 600;
}

button:disabled {
  opacity: 0.4;
}

.tabs {
  display: flex;
  gap: 10px;
  margin-top: 16px;
}

.tabs button {
  flex: 1;
}

.range-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 16px;
}

.bar {
  margin-top: 14px;
}

.bar-track {
  height: 12px;
  background: rgba(255,255,255,0.3);
  border-radius: 6px;
  overflow: hidden;
}

.bar-fill {
  height: 100%;
  background: #ffffff;
}

.footer {
  margin-top: 40px;
  text-align: center;
  font-family: 'Pacifico', cursive;
  font-size: 16px;
  opacity: 0.95;
}
</style>
</head>

<body>
<div class="container">

<h1>CoDrive</h1>

<select id="from">
  <option value="">From</option>
  <option value="eldorado">Eldorado</option>
  <option value="manyata">Manyata</option>
</select>

<select id="to">
  <option value="">To</option>
  <option value="eldorado">Eldorado</option>
  <option value="manyata">Manyata</option>
</select>

<button id="showBtn" style="display:none;">Show Popularity</button>

<div id="dayTabs" class="tabs" style="display:none;">
  <button id="todayTab">Today</button>
  <button id="tomorrowTab">Tomorrow</button>
</div>

<div id="ranges" class="range-grid"></div>
<div id="results"></div>

<select id="slotSelect" style="display:none;"></select>
<button id="voteBtn" style="display:none;">My Preference</button>

<div class="footer">
  <div>Finding co-driving partner</div>
  <div>Created by Animesh</div>
</div>

</div>

<script>
const WORKER_URL = "https://codrive.animesh-him.workers.dev";

const fromSel = document.getElementById("from");
const toSel = document.getElementById("to");
const showBtn = document.getElementById("showBtn");
const rangesDiv = document.getElementById("ranges");
const resultsDiv = document.getElementById("results");
const slotSelect = document.getElementById("slotSelect");
const voteBtn = document.getElementById("voteBtn");
const dayTabs = document.getElementById("dayTabs");

let activeRange = null;
let activeDayOffset = 0; // 0 = today, 1 = tomorrow

const ranges = [
  { label:"00–06 hours", start:0 },
  { label:"06–12 hours", start:6 },
  { label:"12–18 hours", start:12 },
  { label:"18–24 hours", start:18 }
];

function istNow() {
  return new Date(new Date().toLocaleString("en-US",{ timeZone:"Asia/Kolkata" }));
}

function dateStr(offsetDays) {
  const d = istNow();
  d.setDate(d.getDate() + offsetDays);
  return d.toISOString().slice(0,10);
}

function rangeIsPast(start) {
  if (activeDayOffset === 1) return false;
  const now = istNow();
  const end = new Date(now);
  end.setHours(start + 6, 0, 0, 0);
  return now >= end;
}

function slotsForRange(start) {
  const now = istNow();
  const slots = [];

  for (let h = start; h < start + 6; h++) {
    for (let m of [0,30]) {
      const slotTime = new Date(now);
      slotTime.setHours(h, m, 0, 0);
      if (activeDayOffset === 1 || slotTime > now) {
        const endH = m === 30 ? h + 1 : h;
        const endM = m === 30 ? "00" : "30";
        slots.push(
          `${String(h).padStart(2,"0")}:${m === 0 ? "00" : "30"}-` +
          `${String(endH).padStart(2,"0")}:${endM}`
        );
      }
    }
  }
  return slots;
}

fromSel.onchange = toSel.onchange = () => {
  showBtn.style.display = fromSel.value && toSel.value ? "block" : "none";
};

showBtn.onclick = () => {
  dayTabs.style.display = "flex";
  activeDayOffset = 0;
  renderRanges();
};

document.getElementById("todayTab").onclick = () => {
  activeDayOffset = 0;
  renderRanges();
};

document.getElementById("tomorrowTab").onclick = () => {
  activeDayOffset = 1;
  renderRanges();
};

function renderRanges() {
  rangesDiv.innerHTML = "";
  resultsDiv.innerHTML = "";
  slotSelect.style.display = "none";
  voteBtn.style.display = "none";

  ranges.forEach(r => {
    const btn = document.createElement("button");
    btn.textContent = r.label;
    btn.disabled = rangeIsPast(r.start);
    btn.onclick = () => loadPopularity(r.start);
    rangesDiv.appendChild(btn);
  });
}

async function loadPopularity(start) {
  activeRange = start;
  const slots = slotsForRange(start);
  if (!slots.length) return;

  const res = await fetch(WORKER_URL + "/popularity", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      date: dateStr(activeDayOffset),
      from: fromSel.value,
      to: toSel.value,
      slots
    })
  });

  const data = await res.json();
  resultsDiv.innerHTML = "";
  slotSelect.innerHTML = "";

  const max = Math.max(1, ...Object.values(data));

  slots.forEach(s => {
    const count = data[s];
    const div = document.createElement("div");
    div.className = "bar";
    div.innerHTML = `
      <div>${s} (${count})</div>
      <div class="bar-track">
        <div class="bar-fill" style="width:${(count/max)*100}%"></div>
      </div>
    `;
    resultsDiv.appendChild(div);

    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    slotSelect.appendChild(opt);
  });

  slotSelect.style.display = "block";
  voteBtn.style.display = "block";
}

voteBtn.onclick = async () => {
  const slot = slotSelect.value;

  await fetch(WORKER_URL + "/vote", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      date: dateStr(activeDayOffset),
      from: fromSel.value,
      to: toSel.value,
      slot
    })
  });

  loadPopularity(activeRange);
};
</script>
</body>
</html>
