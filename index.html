<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CoDrive</title>

<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
/* ---------- EXISTING STYLES (UNCHANGED) ---------- */
body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system;
  color: #fff;
  background: linear-gradient(
    270deg,
    #f58529,
    #fd1d1d,
    #dd2a7b,
    #8134af,
    #515bd4,
    #feda77
  );
  background-size: 1200% 1200%;
  animation: insta 5s linear infinite;
}

@keyframes insta {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* ---------- VIDEO HEADER ---------- */
.video-header {
  position: relative;
  max-width: 420px;
  height: 220px;
  margin: auto;
  overflow: hidden;
}

.video-header video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
  .video-title {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;   
  align-items: center;
  justify-content: center;
  text-align: center;       
  font-family: 'Caveat', cursive;
  }
  @keyframes titleMove {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
  .title-main {
  font-family: 'Caveat', cursive;
  font-size: 88px;      /* increase heading size */
  line-height: 1.1;
  }
.title-tagline {
  margin-top: 6px;
  font-family: 'Caveat', cursive;
  font-size: 14px;
  line-height: 1.2;
  opacity: 0.9;
}

.container {
  max-width: 420px;
  margin: auto;
  padding: 16px;
}

/* Hide duplicate title safely */
h1 {
  display: none;
}

/* ---------- INPUT SIZE REDUCTION ---------- */
select, button {
  padding: 12px;
  margin-top: 12px;
  border-radius: 10px;
  border: none;
  font-size: 15px;
}

.tabs {
  display: flex;
  justify-content: space-between;
  gap: 12px;
}
  
button {
  background: white;
  color: black;
  font-weight: 600;
}

.bar {
  margin-top: 10px;
}
  
.bar-label {
  font-size: 11px;
  opacity: 0.9;
  margin-bottom: 4px;
}

.track {
  height: 8px;
  background: rgba(255,255,255,0.25);
  border-radius: 4px;
  overflow: hidden;
}

.fill {
  height: 100%;
  background: #fff;
}

.muted {
  font-size: 12px;
  opacity: 0.8;
  margin-top: 12px;
  text-align: center;
}

  .pref-btn {
  background: #000;
  color: #fff;
  border: none;
  font-family: 'Caveat', cursive;
  font-size: 18px;
  width: 50%;
}

.pref-btn.active {
  background: #333;
}

.footer {
  margin-top: 40px;
  text-align: center;
  font-family: 'Caveat', cursive;
  font-size: 15px;
}

.credit {
  animation: floatText 2.5s ease-in-out infinite;
  text-transform: none;
  letter-spacing: 0.4px;
}

@keyframes floatText {
  0% { opacity: 0.6; }
  50% { opacity: 1; }
  100% { opacity: 0.6; }
}
  /* ===== WEEKEND MEET ===== */
.weekend-box {
  margin-top: 28px;
  padding-top: 16px;
  border-top: 1px solid rgba(255,255,255,0.3);
  text-align: center;
}
.circle-wrap {
  display: flex;
  justify-content: center;
  gap: 24px;
  margin-top: 14px;
  font-family: 'Caveat', cursive;
}
.circle {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: #000;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: bold;
}
/*
.weekend-title {
  font-family: 'Caveat', cursive;
  font-size: 24px;   /* ‚¨ÖÔ∏è increase this */
/*  line-height: 1.15;
  font-weight: 600;
}
.weekend-meta,*/
.circle-label {
  font-family: 'Caveat', cursive;
}
.tabs button {
  background-color: #ffffff;
  color: #000000;
  border: 1px solid #ccc;
  width: 50%;
}

/* Active tab (today / tomorrow) */
.tabs button.active {
  background-color: #4a4a4a; /* dark gray */
  color: #ffffff;
}
  .weekend-box button {
  font-family: 'Caveat', cursive;
  font-size: 16px;
  }

  /* ===== TO LOCATION CODE UI===== */
.to-code-wrap {
  margin-top: 16px;
  text-align: center;
}

.to-code-row {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 14px;
}

.code-circle-btn {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background-color: #ffffff;
  color: #000000;
  font-weight: 700;
  font-size: 18px;
  border: none;
}

.code-circle-btn:disabled {
  opacity: 0.4;
}

/* ===== FULLSCREEN CODE (WHITE-SCREEN GUARANTEE) ===== */
.fullscreen-code {
  position: fixed;
  inset: 0;
  background-color: #ffffff !important;
  color: #000000 !important;
  display: none;
  align-items: center;
  justify-content: center;
  font-size: min(40vw, 90vh);
  font-weight: 900;
  z-index: 2147483647;
}

.fullscreen-code.active {
  display: flex;
}
  /* ===== FULLSCREEN CODE TEXT LAYOUT ===== */
#fullscreenCode {
  align-items: flex-start;   /* top */
  padding-top: 4px;
}

#fullscreenCodeText {
  width: 100%;
  text-align: center;
}

.fs-line {
  width: 100%;
  text-align: center;
}

.fs-date {
  font-size: 20px;
  margin-bottom: 16px;
}

.fs-route,
.fs-role {
  font-size: 64px;
  font-weight: 900;
  margin-bottom: 12px;
  line-height: 1.1;
  word-break: break-word;
}
  .fs-explain {
  font-size: 10px;
  opacity: 0.7;
  margin-bottom: 12px;
}

#qrWrap {
  display:flex;
  justify-content:center;
  margin-top:12px;
  position:relative;
}

  .ig-link {
  text-decoration: none;
  font-weight: 600;
  background: linear-gradient(270deg, #ff0057, #ffb300, #00e5ff, #8e2de2);
  background-size: 800% 800%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: igGlow 6s ease infinite;
}

@keyframes igGlow {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

  .weekend-video-bg {
  position: relative;
  overflow: hidden;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  height: 260px;
  background: #000; /* fallback if video fails */
  }

.weekend-video-bg video {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter: brightness(0.85);
  z-index: 0;
  transform: translateZ(0);
}
/*
.weekend-video-content {
  position: relative;
  z-index: 1;
  text-align: center;
  font-family: 'Caveat', cursive;
}*/
  .weekend-video-content {
  font-family: 'Caveat', cursive;
    position: absolute;
  inset: 0;
  padding: 12px;
  box-sizing: border-box;
  overflow: hidden;
}

.weekend-title,
.weekend-meta {
  font-family: 'Caveat', cursive;
  word-break: break-word;
}
.tabs .pref-btn {
  background: #000 !important;
  color: #fff !important;
  border: none !important;
}
  .to-code-row select {
  width: 100%;
  min-width: 0;
}

.to-code-row {
  flex-wrap: nowrap;
}
  .to-code-wrap {
  max-width: 420px;
  margin: 16px auto 0 auto;
  padding: 0 8px;
  }
  #toCodeSelect {
  flex: 1;
  }
.route-row {
  display: flex;
  justify-content: center;
  gap: 12px;
}
  .route-row select {
  width: 48%;
  }

  /* ===== CENTER TIME SLOT DROPDOWN ===== */
#slotSelect {
  display: block;
  margin: 16px auto;
  text-align: center;
  max-width: 240px;
}
#codeActionRow {
  display: flex;
  justify-content: center;
  gap: 16px;
}

#codeActionRow button {
  background:#000;
  color:#fff;
  font-family:'Caveat', cursive;
  font-size:18px;
  padding:12px 18px;
}
  #fullscreenCode {
  overflow: auto;
}

#fullscreenCodeText {
  background: #fff;
  padding-bottom: 20px;
}
  .fs-title {
  font-family: 'Caveat', cursive;
  font-size: 22px;          /* half-ish of route line */
  text-align: center;
  margin-bottom: 6px;
  opacity: 0.9;
  }
  /* ===== ATTEND AS RIDER / OWNER SAME LINE ===== */
.role-select {
  display: flex;
  font-family: 'Caveat', cursive;
  justify-content: center;
  align-items: center;
  gap: 16px;
  margin-top: 14px;
  flex-wrap: nowrap;          /* prevents line break */
}

.role-select button {
  white-space: nowrap;        /* text stays in one line */
}
</style>
</head>

<body>

<!-- VIDEO HEADER (OUTSIDE LOGIC AREA) -->
<div class="video-header">
  <video autoplay muted loop playsinline preload="metadata">
    <source src="https://animesh-him.github.io/CoDrive/codrive1.mp4" type="video/mp4">
  </video>
  <div class="video-title">
  <div class="title-main gradient-text">CoDrive</div>
  <div class="title-tagline gradient-text">
    My co-driving partner!
  </div>
</div>
</div>

<div class="container">

<h1>CoDrive</h1>

<div class="tabs">
  <button id="todayBtn" class="active">Today</button>
  <button id="tomorrowBtn">Tomorrow</button>
</div>

<div class="to-code-row route-row">
  <select id="from">
    <option value="">From</option>
  </select>

  <select id="to">
    <option value="">To</option>
  </select>
</div>
  
<div id="popularity"></div>

<select id="slotSelect">
  <option value="" disabled selected>Time slot</option>
</select>
<div class="tabs">
  <button id="riderPrefBtn" class="pref-btn">Rider</button>
  <button id="providerPrefBtn" class="pref-btn">Provider</button>
</div>

<div id="codeActionRow" style="display:none;">
  <button id="showCodeBtn" disabled>Show Code</button>
  <button id="saveQrBtn" disabled>Save QR Code</button>
</div>

<!-- ===== TO LOCATION CODE SELECT ===== -->
  <div class="to-code-wrap">
    <div class="weekend-meta muted">Rider/Owner show below CODE to match Destination.</div>
  <div class="to-code-row">
    <select id="toCodeSelect">
      <option value="">Select To location (with code)</option>
    </select>

    <button id="codeCircleBtn" class="code-circle-btn" disabled>
      --
    </button>
  </div>
</div>

<!-- FULLSCREEN CODE VIEW -->
<div id="fullscreenCode" class="fullscreen-code">
  <span id="fullscreenCodeText"></span>
</div>

 <!-- üÜï WEEKEND COMMUNITY MEET-->
<div class="weekend-box">
  <div class="weekend-video-bg">
  <video autoplay muted loop playsinline preload="metadata"
    poster="data:image/gif;base64,R0lGODlhAQABAAAAACw=">
    <source src="https://animesh-him.github.io/CoDrive/footerfinal.mp4" type="video/mp4">
  </video>

  <div class="weekend-video-content">
    <div class="weekend-title">CoDrive Weekend Community Meet</div>
    <div class="weekend-meta">
      <span id="weekendDate"></span><br>
      Time- 5:00 PM ‚Äì 5:30 PM<br>
      Location- Brigade Eldorado Amphithetre.<br>
      Step-1 After arriving at Venue,click on your nearest To Location Code.<br>
      Step-2 Tap on code,it will fill your mobile screen fully,show that code to everyone, relevant people of the same code can group and discuss their slots frequency and join a provider if available or decide to co drive by booking together.<br>
      Step-3 Join the whatsapp community link given at the end of app page and then undeneath it relevant To Location groups, so you dont miss contacts and discuss at your convenience.<br>
      Time- 5:30 PM - 6:00 PM<br>
      Music Enthusiasts can play / sing along, jam like the backbenchers of class. There isn't any electronic arrangements, it would be purely a symphony of human voice.<br>
      Bring your Guitar and Vocal Cords to sound professional!<br>
      Dont be shy like me! Kise pata Kal Ho Na Ho!
    </div>
  </div>
</div>
  <select id="societySelect">
    <option value="eldorado">Brigade Eldorado</option>
  </select>

  <<div class="role-select">
  <button id="riderBtn">Attend as Rider</button>
  <button id="ownerBtn">Attend as Car Owner</button>
  </div>
  <div class="circle-wrap">
    <div>
      <div class="circle" id="riderCount">0</div>
      <div class="circle-label">Riders</div>
    </div>
    <div>
      <div class="circle" id="ownerCount">0</div>
      <div class="circle-label">Owners</div>
    </div>
  </div>
 
</div> 
</div>

<script>
  
function fitTextToBox(container, min = 10) {
  const textEls = container.querySelectorAll('.weekend-title, .weekend-meta');

  let size = 24; // start size
  textEls.forEach(el => el.style.fontSize = size + 'px');

  while (container.scrollHeight > container.clientHeight && size > min) {
    size--;
    textEls.forEach(el => el.style.fontSize = size + 'px');
  }
}

// call after content loads
window.addEventListener('load', () => {
  const box = document.querySelector('.weekend-video-content');
  fitTextToBox(box);
});

/* ===== CENTRAL LOCATION REGISTRY ==== */
const LOCATIONS = {
  eldorado: { name: "Brigade Eldorado", includeFrom: true, includeTo: false },
  godrej: { name: "Godrej Ananda", includeFrom: true, includeTo: false },
  prestige: { name: "Prestige Finsbury Park", includeFrom: true, includeTo: false },

  bagmane: { name: "Bagmane Tech Park, CV Raman Nagar", includeFrom: false, includeTo: true },
  boeing: { name: "Boeing Office (North Bangalore)", includeFrom: false, includeTo: true },
  cubbon: { name: "Cubbon Park", includeFrom: false, includeTo: true },
  dynamatics: { name: "Dynamatics (North Bangalore)", includeFrom: false, includeTo: true },
  ecospace: { name: "Ecospace (Bellandur)", includeFrom: false, includeTo: true },
  electronic_city: { name: "Electronic City", includeFrom: false, includeTo: true },
  itpl: { name: "ITPL (Whitefield)", includeFrom: false, includeTo: true },
  karle_sez: { name: "KARLE SEZ", includeFrom: false, includeTo: true },
  kia_t1: { name: "Kempegowda International Airport T1", includeFrom: false, includeTo: true },
  kia_t2: { name: "Kempegowda International Airport T2", includeFrom: false, includeTo: true },
  koramangala: { name: "Koramangala", includeFrom: false, includeTo: true },
  mg_road: { name: "MG Road", includeFrom: false, includeTo: true },
  manyata: { name: "Manyata Tech Park", includeFrom: false, includeTo: true },
  sap_labs: { name: "SAP Labs (North Bangalore)", includeFrom: false, includeTo: true },
  sarjapur: { name: "Sarjapur", includeFrom: false, includeTo: true },
  shell: { name: "Shell Technology Center (North Bangalore)", includeFrom: false, includeTo: true }
};
  const WORKER = "https://codrive-api.animesh-him.workers.dev";
let dayOffset = 0;

const todayBtn = document.getElementById("todayBtn");
const tomorrowBtn = document.getElementById("tomorrowBtn");
const fromSel = document.getElementById("from");
const toSel = document.getElementById("to");
/* ===== GLOBAL LOCATION CODE MAP ===== */
const locationCodes = {};
(() => {
  const allLocations = Object.entries(LOCATIONS)
    .map(([value, obj]) => ({ value, name: obj.name }))
    .sort((a, b) => a.name.localeCompare(b.name));

  const letterCount = {};
  allLocations.forEach(loc => {
    const letter = loc.name[0].toUpperCase();
    letterCount[letter] = (letterCount[letter] || 0) + 1;
    locationCodes[loc.value] = letter + letterCount[letter];
  });
})();
  function populateFromTo() {
  fromSel.innerHTML = `<option value="">From</option>`;
  toSel.innerHTML = `<option value="">To</option>`;

  Object.entries(LOCATIONS).forEach(([value, loc]) => {
    const label = `${loc.name} (${locationCodes[value]})`;

    if (loc.includeFrom) {
      fromSel.appendChild(new Option(label, value));
    }
    if (loc.includeTo) {
      toSel.appendChild(new Option(label, value));
    }
  });
}

populateFromTo();
  const popDiv = document.getElementById("popularity");
const slotSel = document.getElementById("slotSelect");
const riderPrefBtn = document.getElementById("riderPrefBtn");
const providerPrefBtn = document.getElementById("providerPrefBtn");
const showCodeBtn = document.getElementById("showCodeBtn");
  slotSel.addEventListener("change", () => {
  hasVotedThisSlot = false;
  justVoted = false;
  lastVotePosition = null;
  selectedRole = null;

  riderPrefBtn.disabled = false;
  providerPrefBtn.disabled = false;
  
});

let selectedRole = null; // "R" or "P"
let lastVotePosition = null;
  let justVoted = false;
  let hasVotedThisSlot = false;

let slotMap = {};  
  
todayBtn.onclick = () => setDay(0);
tomorrowBtn.onclick = () => setDay(1);
fromSel.addEventListener("change", () => {
  [...toSel.options].forEach(o => {
    o.disabled = o.value === fromSel.value && o.value !== "";
  });
  loadPopularity();
});

toSel.addEventListener("change", () => {
  [...fromSel.options].forEach(o => {
    o.disabled = o.value === toSel.value && o.value !== "";
  });
  loadPopularity();
});

function setDay(d) {
  dayOffset = d;
  todayBtn.classList.toggle("active", d === 0);
  tomorrowBtn.classList.toggle("active", d === 1);
  loadPopularity();
}

function istNow() {
  return new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Kolkata"}));
}

function dateStr() {
  const d = istNow();
  d.setDate(d.getDate() + dayOffset);
  return d.toISOString().slice(0,10);
}

function futureSlots() {
  const now = istNow();
  const base = new Date(now);
  base.setHours(0, 0, 0, 0);

  const slots = [];

  for (let h = 0; h < 24; h++) {
    for (let m of [0, 30]) {

      // Absolute slot index: S1 = 00:00‚Äì00:30
      const absoluteIndex = h * 2 + (m === 30 ? 2 : 1);

      const start = new Date(base);
      start.setHours(h, m, 0, 0);

      const end = new Date(start);
      end.setMinutes(end.getMinutes() + 30);

      // TODAY ‚Üí only future end times
      // TOMORROW ‚Üí allow all
      if (dayOffset === 1 || end > now) {
        const sh = String(start.getHours()).padStart(2, "0");
        const sm = String(start.getMinutes()).padStart(2, "0");
        const eh = String(end.getHours()).padStart(2, "0");
        const em = String(end.getMinutes()).padStart(2, "0");

        slots.push({
          label: `${sh}:${sm}-${eh}:${em}`,
          code: "S" + absoluteIndex
        });
      }
    }
  }
  return slots;
}
function restoreStateFromPopularity(data) {
  if (!slotSel.value) return;

  const d = data[slotSel.value];
  if (!d) return;

  // If already voted in this session, lock UI
  if (hasVotedThisSlot) {
    riderPrefBtn.disabled = true;
    providerPrefBtn.disabled = true;
    
  } else {
    riderPrefBtn.disabled = false;
    providerPrefBtn.disabled = false;
    
  }
}
  
async function loadPopularity() {
 const prevSlot = slotSel.value;
  
  popDiv.innerHTML = "";
  slotSel.innerHTML = `<option value="" disabled selected>Time slot</option>`;

  if (!fromSel.value || !toSel.value) return;

  const slots = futureSlots();
  if (!slots.length) return;

  let data = {};
  try {
    const res = await fetch(WORKER + "/popularity", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        date: dateStr(),
        from: fromSel.value,
        to: toSel.value,
        slots: slots.map(s => s.label)
      })
    });
    data = await res.json();
  } catch {}

  const entries = slots
    .map(s => {
  const d = data[s.label] || { R: 0, P: 0 };
  return {
    slot: s,
    R: d.R,
    P: d.P,
    total: d.R + d.P
  };
})
.filter(e => e.total > 0);

  if (entries.length === 0) {
    popDiv.innerHTML = `<div class="muted">No preferences yet for future slots</div>`;
  } else {
    const max = Math.max(...entries.map(e => e.total));
    entries.forEach(e => {
      const bar = document.createElement("div");
      bar.className = "bar";
      bar.innerHTML = `
        <div class="bar-label">${e.slot.label} (${e.slot.code}) ‚Ä¢ 
${e.P} Providers &nbsp; ${e.R} Riders</div>
          <div class="track">
  <div style="
    display:flex;
    height:100%;
    width:${(e.total / max) * 100}%;
  ">
    <div style="
      width:${(e.P / e.total) * 100}%;
      background:#40e0d0;
    "></div>
    <div style="
      width:${(e.R / e.total) * 100}%;
      background:#ffffff;
    "></div>
  </div>
        </div>
      `;
      popDiv.appendChild(bar);
    });
  }

  slotMap = {}; // reset

slots.forEach(s => {
  slotMap[s.label] = s;

  const opt = document.createElement("option");
  opt.value = s.label;
  opt.textContent = `${s.label} (${s.code})`;
  slotSel.appendChild(opt);
});
  if (prevSlot && slotMap[prevSlot]) {
  slotSel.value = prevSlot;
  }
  restoreStateFromPopularity(data);
}


async function submitVote() {
  if (hasVotedThisSlot) {
    alert("You have already voted for this slot");
    return;
  }

  if (!fromSel.value || !toSel.value || !slotSel.value || !selectedRole) return;

  const slotObj = slotMap[slotSel.value];
  if (!slotObj) return;

  const res = await fetch(WORKER + "/vote", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      date: dateStr(),
      from: fromSel.value,
      to: toSel.value,
      slot: slotObj.label,
      role: selectedRole
    })
  });

  const data = await res.json();

  lastVotePosition = data.position;
  hasVotedThisSlot = true;
  justVoted = true;

  riderPrefBtn.disabled = true;
  providerPrefBtn.disabled = true;

  const codeActionRow = document.getElementById("codeActionRow");
const saveQrBtn = document.getElementById("saveQrBtn");

codeActionRow.style.display = "flex";
showCodeBtn.disabled = false;
saveQrBtn.disabled = true; // only enabled AFTER QR generation

  loadPopularity();
  
}
riderPrefBtn.addEventListener("click", () => {
  selectedRole = "R";
  submitVote();
});

providerPrefBtn.addEventListener("click", () => {
  selectedRole = "P";
  submitVote();
});
</script>
  <script>
/* ===== WEEKEND MEET LOGIC (SAFE ADDITION) ===== */

const weekendDateEl = document.getElementById("weekendDate");
const riderBtn = document.getElementById("riderBtn");
const ownerBtn = document.getElementById("ownerBtn");
const riderCountEl = document.getElementById("riderCount");
const ownerCountEl = document.getElementById("ownerCount");

function nextSaturday() {
  const d = istNow(); // uses existing function
  const day = d.getDay();
  const diff = (6 - day + 7) % 7 || 7;
  d.setDate(d.getDate() + diff);
  d.setHours(0,0,0,0);
  return d;
}

function saturdayKey() {
  return nextSaturday().toISOString().slice(0,10);
}

function formatSaturday(d) {
  return d.toLocaleDateString("en-IN", {
    weekday: "long",
    day: "numeric",
    month: "short"
  });
}

async function loadWeekend() {
  const key = saturdayKey();
  weekendDateEl.textContent = formatSaturday(nextSaturday());

  const res = await fetch(WORKER + "/weekend/get", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ date: key })
  });

  const data = await res.json();
  riderCountEl.textContent = data.riders ?? 0;
  ownerCountEl.textContent = data.owners ?? 0;
}

async function voteWeekend(type) {
  const key = saturdayKey();
  await fetch(WORKER + "/weekend/vote", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ date: key, type })
  });
  loadWeekend();
}

riderBtn.onclick = () => voteWeekend("riders");
ownerBtn.onclick = () => voteWeekend("owners");

window.addEventListener("load", loadWeekend);

  
  </script>

  <script>
/* ===== TO LOCATION CODE LOGIC (AUTO-SYNC SAFE) ===== */
let latestQrPayload = "";
window.addEventListener("DOMContentLoaded", () => {

  const toSelect = document.getElementById("to");           // existing
  const toCodeSelect = document.getElementById("toCodeSelect");
  
  const codeCircleBtn = document.getElementById("codeCircleBtn");
  showCodeBtn.addEventListener("click", () => {
  if (!toSel.value) {
    alert("Please select destination");
    return;
  }
  codeCircleBtn.click();
});
  const fullscreenCode = document.getElementById("fullscreenCode");
  const fullscreenCodeText = document.getElementById("fullscreenCodeText");

  if (!toSelect || !toCodeSelect || !codeCircleBtn) return;

  /* Build maps from central registry */
const toValueToName = {};
const toNameToValue = {};

Object.entries(LOCATIONS).forEach(([value, loc]) => {
  if (loc.includeTo) {
    toValueToName[value] = loc.name;
    toNameToValue[loc.name] = value;
  }
});

/* Populate To-Code dropdown */
Object.entries(toValueToName)
  .sort((a, b) => a[1].localeCompare(b[1]))
  .forEach(([value, name]) => {
    const opt = document.createElement("option");
    opt.value = locationCodes[value];
    opt.textContent = `${name} (${locationCodes[value]})`;
    toCodeSelect.appendChild(opt);
  });

  /* === SYNC: To location ‚Üí Code === */
  toSelect.addEventListener("change", () => {
  const value = toSelect.value;
  if (!value) {
    codeCircleBtn.textContent = "--";
    codeCircleBtn.disabled = true;
    toCodeSelect.value = "";
    return;
  }
  const code = locationCodes[value];
  toCodeSelect.value = code;
  codeCircleBtn.textContent = code;
  codeCircleBtn.disabled = false;
});
  // 1Ô∏è‚É£ Bind location ‚Üí code circle
toCodeSelect.addEventListener("change", () => {
  const code = toCodeSelect.value;

  if (!code) {
    codeCircleBtn.textContent = "--";
    codeCircleBtn.disabled = true;
    return;
  }

  codeCircleBtn.textContent = code;
  codeCircleBtn.disabled = false;
});

// 2Ô∏è‚É£ Fullscreen view
codeCircleBtn.addEventListener("click", () => {
  if (!slotSel.value || !selectedRole || !lastVotePosition) {
    alert("Please vote first to generate your code");
    return;
  }

  const d = istNow();
  d.setDate(d.getDate() + dayOffset);

  const slotObj = slotMap[slotSel.value];
  if (!slotObj) return;

  const fullDate = d.toLocaleDateString("en-IN", {
    weekday: "long",
    day: "numeric",
    month: "long",
    year: "numeric"
  });

  const roleText =
    `${lastVotePosition}${lastVotePosition === 1 ? "st" :
      lastVotePosition === 2 ? "nd" :
      lastVotePosition === 3 ? "rd" : "th"} ` +
    (selectedRole === "R" ? "Rider" : "Provider");

  const qrPayload = [
    `Date: ${fullDate}`,
    `From: ${LOCATIONS[fromSel.value].name} (${locationCodes[fromSel.value]})`,
    `To: ${LOCATIONS[toSel.value].name} (${locationCodes[toSel.value]})`,
    `Time Slot: ${slotObj.label} (${slotObj.code})`,
    `Position: ${roleText}`,
    `Powered by CoDrive`
  ].join("\n");
  latestQrPayload = qrPayload;

  const explainLine = qrPayload.replace(/\n/g, " ‚Ä¢ ");

  fullscreenCodeText.innerHTML = `
  <div class="fs-title">CoDrive</div>

  <div class="fs-line fs-route">
    ${locationCodes[fromSel.value]}-${locationCodes[toSel.value]}-${slotObj.code}
  </div>

  <div class="fs-line fs-role">
    ${selectedRole}${lastVotePosition}
  </div>

  <div class="fs-line fs-explain">
    ${explainLine}
  </div>

  <div id="qrWrap">
    <div id="qr"></div>
  </div>
`;

  const qrDiv = document.getElementById("qr");
  qrDiv.innerHTML = "";

  new QRCode(qrDiv, {
    text: qrPayload,
    width: 240,
    height: 240,
    colorDark: "#000000",
    colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.H
  });

  saveQrBtn.disabled = false;
  fullscreenCode.classList.add("active");
});
  const saveQrBtn = document.getElementById("saveQrBtn");
  
  saveQrBtn.addEventListener("click", () => {
  const qrCanvas = document.querySelector("#qr canvas");
  if (!qrCanvas) {
    alert("Generate QR first");
    return;
  }

  const poster = document.createElement("canvas");
  poster.width = 600;
  poster.height = 820;

  const ctx = poster.getContext("2d");

  // Background
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, poster.width, poster.height);

  // Title
  ctx.fillStyle = "#000";
  ctx.font = "48px Caveat";
  ctx.textAlign = "center";
  ctx.fillText("CoDrive", poster.width / 2, 60);

// === BIG CODES BELOW CoDrive ===
const fromCode = locationCodes[fromSel.value];
const toCode = locationCodes[toSel.value];

const slotObj = slotMap[slotSel.value];
if (!slotObj) return;

const slotCode = slotObj.code;
const roleCode = selectedRole + lastVotePosition;
// Route code line (B3-S3-S48)
ctx.font = "bold 40px Arial";   // üîß change size here
let y = 120;
ctx.fillText(`${fromCode}-${toCode}-${slotCode}`, poster.width / 2, y);

// Role code line (P5 / R9)
ctx.font = "bold 40px Arial";   // üîß change size here
y += 50;
ctx.fillText(roleCode, poster.width / 2, y);

// === Human readable text continues ===
ctx.font = "20px system-ui";
y += 50;
latestQrPayload.split("\n").forEach(line => {
  ctx.fillText(line, poster.width / 2, y);
  y += 30;
});

  // QR
  ctx.drawImage(qrCanvas, 180, y + 20, 240, 240);

  
  const fileName = `CoDrive_${fromCode}-${toCode}-${slotCode}-${roleCode}.png`;

  const link = document.createElement("a");
  link.download = fileName;
  link.href = poster.toDataURL("image/png");
  link.click();
});

fullscreenCode.addEventListener("click", () => {
  fullscreenCode.classList.remove("active");
});
  /* ===== CHANGE 6: SAVE FULL CODE + QR AS IMAGE ===== */


 });   
</script>
<script>
/* ===== BUTTON COOLDOWN + FLASH MESSAGE (10s, MEMORY ONLY) ===== */
(function () {
  const COOLDOWN_MS = 10000; // 10 seconds
  const lastClick = new WeakMap();
  let flashEl = null;
  let flashTimer = null;

  function showFlash(secondsLeft) {
    if (!flashEl) {
      flashEl = document.createElement("div");
      flashEl.style.position = "fixed";
      flashEl.style.bottom = "24px";
      flashEl.style.left = "50%";
      flashEl.style.transform = "translateX(-50%)";
      flashEl.style.background = "rgba(0,0,0,0.85)";
      flashEl.style.color = "#fff";
      flashEl.style.padding = "10px 16px";
      flashEl.style.borderRadius = "12px";
      flashEl.style.fontSize = "14px";
      flashEl.style.zIndex = "2147483647";
      flashEl.style.fontFamily = "system-ui, -apple-system";
      flashEl.style.boxShadow = "0 6px 18px rgba(0,0,0,0.3)";
      flashEl.style.transition = "opacity 0.2s ease";
      document.body.appendChild(flashEl);
    }

    flashEl.textContent = `Please wait ${secondsLeft}s before clicking again`;
    flashEl.style.opacity = "1";

    clearTimeout(flashTimer);
    flashTimer = setTimeout(() => {
      if (flashEl) flashEl.style.opacity = "0";
    }, 1200);
  }

  function protect(btn) {
    if (!btn || !btn.onclick) return;

    const original = btn.onclick;

    btn.onclick = async function (...args) {
      const now = Date.now();
      const last = lastClick.get(btn) || 0;
      const remaining = COOLDOWN_MS - (now - last);

      if (remaining > 0) {
        showFlash(Math.ceil(remaining / 1000));
        return;
      }

      lastClick.set(btn, now);

      try {
        await original.apply(this, args);
      } catch (e) {
        console.error(e);
      }
    };
  }

  window.addEventListener("load", () => {
    //protect(document.getElementById("voteBtn"));
    protect(document.getElementById("riderBtn"));
    protect(document.getElementById("ownerBtn"));
  });
})();
</script>
  
<div class="footer">
  <div class="muted">
  Follow this link to join CoDrive WhatsApp community:
  <a class="ig-link" href="https://chat.whatsapp.com/GyGxqYo2FamHvwnhJPa1sk" target="_blank">
    Click Here
  </a>
</div>
    <div class="muted">
   @Copyleft Licensed under GNU GPLv3.0
  </div>
  <div class="credit">Created by Animesh</div>
</div>
  
</body>
</html>
