<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CoDrive</title>

<style>
:root{
  --grad: linear-gradient(270deg,#ff0066,#ff9900,#9933ff);
}
*{box-sizing:border-box;font-family:system-ui,-apple-system;}
body{
  margin:0;
  min-height:100vh;
  background:var(--grad);
  background-size:600% 600%;
  animation:bgMove 12s ease infinite;
  color:#fff;
}
@keyframes bgMove{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
.container{max-width:520px;margin:auto;padding:16px;}
h1{text-align:center;font-family:cursive;}
.tabs{display:flex;justify-content:center;gap:8px;margin-bottom:14px;}
.tabs button{
  border:none;padding:8px 14px;border-radius:20px;
  background:rgba(255,255,255,.25);color:#fff;cursor:pointer;
}
.tabs button.active{background:#fff;color:#000;}
.card{background:rgba(0,0,0,.25);border-radius:16px;padding:16px;}
select,button{
  width:100%;padding:12px;border-radius:10px;
  border:none;margin-top:10px;font-size:15px;
}
button{background:#fff;color:#000;font-weight:600;}
.results{margin-top:16px;}
.slot{display:flex;align-items:center;gap:10px;margin:6px 0;}
.bar{
  height:10px;
  background:#fff;
  border-radius:6px;
  transition:width .6s ease;
}
.small{font-size:13px;opacity:.9;}
.footer{text-align:center;margin-top:10px;font-family:cursive;opacity:.85;}
</style>
</head>

<body>
<div class="container">
  <h1>CoDrive</h1>
  <div class="tabs" id="tabs"></div>

  <div class="card">
    <select id="from"></select>
    <select id="to"></select>
    <select id="time"></select>
    <button id="submitBtn">Select Route</button>
    <div class="results" id="results"></div>
  </div>

  <div class="footer" id="visits"></div>
  <div class="footer">Created by Animesh</div>
</div>

<script>
const API="https://codrive-api.animesh-him.workers.dev";
let currentDate="";

/* ---------- LOCATIONS WITH STABLE IDS ---------- */

const FROM_LOCATIONS = [
  {id:"brigade_eldorado", label:"Brigade Eldorado Aerospace Park"},
  {id:"prestige_finsbury", label:"Prestige Finsbury Aerospace Park"},
  {id:"godrej_ananda", label:"Godrej Ananda Aerospace Park"},
  {id:"provident_ecopolitan", label:"Provident Ecopolitan Aerospace Park"}
];

const TO_LOCATIONS = [
  {id:"karle_sez", label:"KARLE SEZ"},
  {id:"manyata", label:"Manyata Tech Park"},
  {id:"shell", label:"Shell Technology Center (North Bangalore)"},
  {id:"boeing", label:"Boeing Office (North Bangalore)"},
  {id:"sap", label:"SAP Labs (North Bangalore)"},
  {id:"dynamatics", label:"Dynamatics (North Bangalore)"},
  {id:"itpl", label:"ITPL (Whitefield)"},
  {id:"ecospace", label:"Ecospace (Bellandur)"},
  {id:"kia_t1", label:"Kempegowda International Airport T1"},
  {id:"kia_t2", label:"Kempegowda International Airport T2"},
  {id:"cubbon", label:"Cubbon Park"},
  {id:"koramangala", label:"Koramangala"},
  {id:"mg_road", label:"MG Road"},
  {id:"electronic_city", label:"Electronic City"},
  {id:"bagmane", label:"Bagmane Tech Park CV Raman Nagar"},
  {id:"sarjapur", label:"Sarjapur"}
];

/* ---------- IST HELPERS ---------- */
function nowIST(){
  return new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Kolkata"}));
}
function istDateString(o=0){
  const d=nowIST(); d.setDate(d.getDate()+o);
  return d.toISOString().slice(0,10);
}

/* ---------- LOAD SELECTS ---------- */
function loadLocations(){
  from.innerHTML="";
  FROM_LOCATIONS.forEach(l=>{
    const o=document.createElement("option");
    o.value=l.id;
    o.textContent=l.label;
    from.appendChild(o);
  });

  to.innerHTML="";
  TO_LOCATIONS.forEach(l=>{
    const o=document.createElement("option");
    o.value=l.id;
    o.textContent=l.label;
    to.appendChild(o);
  });

  ["from","to","time"].forEach(id=>{
    document.getElementById(id).onchange=refresh;
  });
}

/* ---------- DATES ---------- */
function genDates(){
  tabs.innerHTML="";
  [{l:"Today",v:istDateString(0)},{l:"Tomorrow",v:istDateString(1)}]
  .forEach((o,i)=>{
    const b=document.createElement("button");
    b.textContent=o.l;
    if(!i){b.classList.add("active");currentDate=o.v;}
    b.onclick=()=>{
      document.querySelectorAll(".tabs button").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      currentDate=o.v;
      genTimes(); refresh();
    };
    tabs.appendChild(b);
  });
}

/* ---------- TIMES ---------- */
function genTimes(){
  time.innerHTML="";
  const now=nowIST();
  const today=currentDate===istDateString(0);
  const nowMin=now.getHours()*60+now.getMinutes();

  for(let m=0;m<1440;m+=15){
    if(today && m+15<=nowMin) continue;
    const f=x=>String(x).padStart(2,"0");
    const o=document.createElement("option");
    o.value=o.textContent=
      `${f(m/60|0)}:${f(m%60)} - ${f((m+15)/60|0)}:${f((m+15)%60)}`;
    time.appendChild(o);
  }
}

/* ---------- SUBMIT ---------- */
submitBtn.onclick=async()=>{
  await fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      date:currentDate,
      from:from.value,
      to:to.value,
      time:time.value
    })
  });
  refresh();
};

/* ---------- POPULARITY ---------- */
async function refresh(){
  if(!from.value||!to.value) return;

  const q=`?date=${currentDate}&from=${from.value}&to=${to.value}`;
  const data=await fetch(API+q).then(r=>r.json());

  results.innerHTML="<h3>Popularity</h3>";
  if(!data.length){
    results.innerHTML+=`<div class="small">No selections yet</div>`;
    return;
  }

  const max=Math.max(...data.map(d=>d.count));
  data.sort((a,b)=>b.count-a.count).forEach(d=>{
    const row=document.createElement("div");
    row.className="slot";
    row.innerHTML=`<div class="small">${d.time} (${d.count})</div>`;
    const bar=document.createElement("div");
    bar.className="bar";
    bar.style.width=(d.count/max*100)+"%";
    row.appendChild(bar);
    results.appendChild(row);
  });
}

/* ---------- INIT ---------- */
loadLocations();
genDates();
genTimes();
refresh();
fetch(API+"?visit=1").then(()=>visits.textContent="People finding their co-drive partner");
setInterval(refresh,60000);
</script>
</body>
</html>
