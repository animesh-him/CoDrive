<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CoDrive</title>

<style>
:root{--grad:linear-gradient(270deg,#ff0066,#ff9900,#9933ff)}
*{box-sizing:border-box;font-family:system-ui,-apple-system}
body{
  margin:0;min-height:100vh;
  background:var(--grad);background-size:600% 600%;
  animation:bgMove 12s ease infinite;color:#fff
}
@keyframes bgMove{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
.container{max-width:520px;margin:auto;padding:16px}
h1{text-align:center;font-family:cursive}
.tabs{display:flex;justify-content:center;gap:8px;margin-bottom:14px}
.tabs button{
  border:none;padding:8px 14px;border-radius:20px;
  background:rgba(255,255,255,.25);color:#fff;cursor:pointer
}
.tabs button.active{background:#fff;color:#000}
.card{background:rgba(0,0,0,.25);border-radius:16px;padding:16px}
select,button{
  width:100%;padding:12px;border-radius:10px;
  border:none;margin-top:10px;font-size:15px
}
button.primary{background:#fff;color:#000;font-weight:600}
button.range{
  width:48%;min-height:42px;
  background:#fff;color:#000;font-weight:600
}
button.range.disabled{
  opacity:.4;pointer-events:none
}
.range-wrap{display:flex;flex-wrap:wrap;gap:4%}
.results{margin-top:16px}
.slot{display:flex;gap:10px;margin:6px 0;align-items:center}
.bar{height:10px;background:#fff;border-radius:6px;flex:1}
.small{font-size:13px;opacity:.9}
.label{margin-top:12px;font-size:14px;opacity:.9}
.footer{text-align:center;margin-top:10px;font-family:cursive;opacity:.85}
</style>
</head>

<body>
<div class="container">
  <h1>CoDrive</h1>

  <div class="tabs" id="tabs"></div>

  <div class="card">
    <select id="from"></select>
    <select id="to"></select>

    <div id="rangeSection" style="display:none">
      <div class="label">Select the below time range to see popularity</div>
      <div class="range-wrap" id="ranges"></div>
    </div>

    <select id="time" style="display:none"></select>
    <button id="submitBtn" class="primary" style="display:none">My Preference</button>

    <div class="results" id="results"></div>
  </div>

  <div class="footer" id="visits"></div>
  <div class="footer">Created by Animesh</div>
</div>

<script>
const API="https://codrive-api.animesh-him.workers.dev";
let currentDate="", activeRange=null;

/* ---------- LOCATIONS ---------- */
const FROM_LOCATIONS=[
 {id:"eldorado",label:"Brigade Eldorado Aerospace Park"},
 {id:"finsbury",label:"Prestige Finsbury"},
 {id:"ananda",label:"Godrej Ananda"},
 {id:"ecopolitan",label:"Provident Ecopolitan"}
];
const TO_LOCATIONS=[
 {id:"karle",label:"KARLE SEZ"},
 {id:"manyata",label:"Manyata Tech Park"},
 {id:"shell",label:"Shell Technology Center (North Bangalore)"},
 {id:"boeing",label:"Boeing Office (North Bangalore)"},
 {id:"sap",label:"SAP Labs (North Bangalore)"},
 {id:"dynamatics",label:"Dynamatics (North Bangalore)"},
 {id:"itpl",label:"ITPL (Whitefield)"},
 {id:"ecospace",label:"Ecospace (Bellandur)"},
 {id:"kia1",label:"Kempegowda International Airport T1"},
 {id:"kia2",label:"Kempegowda International Airport T2"},
 {id:"cubbon",label:"Cubbon Park"},
 {id:"koramangala",label:"Koramangala"},
 {id:"mgroad",label:"MG Road"},
 {id:"ecity",label:"Electronic City"},
 {id:"bagmane",label:"Bagmane Tech Park, CV Raman Nagar"},
 {id:"sarjapur",label:"Sarjapur"}
];

/* ---------- IST ---------- */
const nowIST=()=>new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Kolkata"}));
const istDate=o=>{const d=nowIST();d.setDate(d.getDate()+o);return d.toISOString().slice(0,10)};

/* ---------- INIT ---------- */
function fill(sel,data){
  sel.innerHTML="<option value=''>Select</option>";
  data.forEach(o=>{
    const op=document.createElement("option");
    op.value=o.id; op.textContent=o.label;
    sel.appendChild(op);
  });
}

function genDates(){
  tabs.innerHTML="";
  [{l:"Today",v:istDate(0)},{l:"Tomorrow",v:istDate(1)}].forEach((o,i)=>{
    const b=document.createElement("button");
    b.textContent=o.l;
    if(!i){b.classList.add("active");currentDate=o.v}
    b.onclick=()=>{
      [...tabs.children].forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      currentDate=o.v;
      resetUI();
    };
    tabs.appendChild(b);
  });
}

/* ---------- TIME RANGES ---------- */
const RANGES=[
 {label:"00:00 – 06:00",start:0,end:360},
 {label:"06:00 – 12:00",start:360,end:720},
 {label:"12:00 – 18:00",start:720,end:1080},
 {label:"18:00 – 00:00",start:1080,end:1440}
];

function genRanges(){
  ranges.innerHTML="";
  const nowMin=nowIST().getHours()*60+nowIST().getMinutes();
  RANGES.forEach(r=>{
    const b=document.createElement("button");
    b.className="range";
    b.textContent=r.label;
    if(currentDate===istDate(0)&&r.end<=nowMin){
      b.classList.add("disabled");
    }
    b.onclick=()=>selectRange(r);
    ranges.appendChild(b);
  });
}

async function selectRange(r){
  activeRange=r;
  genTimeSlots();
  await loadPopularity();
}

/* ---------- TIME DROPDOWN ---------- */
function genTimeSlots(){
  time.style.display="block";
  submitBtn.style.display="block";
  time.innerHTML="<option value=''>Select time slot</option>";

  const nowMin=nowIST().getHours()*60+nowIST().getMinutes();
  for(let m=activeRange.start;m<activeRange.end;m+=30){
    if(currentDate===istDate(0)&&m+30<=nowMin) continue;
    const f=x=>String(x).padStart(2,"0");
    const h1=f(m/60|0),m1=f(m%60);
    const h2=f((m+30)/60|0),m2=f((m+30)%60);
    const o=document.createElement("option");
    o.value=`${h1}:${m1}-${h2}:${m2}`;
    o.textContent=`${h1}:${m1} - ${h2}:${m2}`;
    time.appendChild(o);
  }
}

/* ---------- POPULARITY ---------- */
async function loadPopularity(){
  const q=`?date=${currentDate}&from=${from.value}&to=${to.value}`;
  const data=await fetch(API+q).then(r=>r.json());
  results.innerHTML="<h3>Popularity</h3>";
  const filtered=data.filter(d=>{
    const h=parseInt(d.time.split(":")[0])*60;
    return h>=activeRange.start && h<activeRange.end;
  });
  if(!filtered.length){results.innerHTML+="<div class='small'>No data</div>";return}
  const max=Math.max(...filtered.map(x=>x.count));
  filtered.forEach(d=>{
    const row=document.createElement("div");
    row.className="slot";
    row.innerHTML=`<div class="small">${d.time} (${d.count})</div>`;
    const bar=document.createElement("div");
    bar.className="bar";bar.style.width=(d.count/max*100)+"%";
    row.appendChild(bar);
    results.appendChild(row);
  });
}

/* ---------- SUBMIT ---------- */
submitBtn.onclick=async()=>{
  if(!from.value||!to.value||!time.value) return;
  const r=await fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({date:currentDate,from:from.value,to:to.value,time:time.value})
  }).then(r=>r.json());
  if(r.error){alert(r.error);return}
  loadPopularity();
};

/* ---------- RESET ---------- */
function resetUI(){
  rangeSection.style.display="none";
  time.style.display="none";
  submitBtn.style.display="none";
  results.innerHTML="";
}

/* ---------- EVENTS ---------- */
[from,to].forEach(s=>s.onchange=()=>{
  if(from.value&&to.value){
    rangeSection.style.display="block";
    genRanges();
  }else resetUI();
});

/* ---------- START ---------- */
fill(from,FROM_LOCATIONS);
fill(to,TO_LOCATIONS);
genDates();
fetch(API+"?visit=1").then(()=>visits.textContent="People finding their co-drive partner");
</script>
</body>
</html>
