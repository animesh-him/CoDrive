<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>CoDrive</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:'Poppins',sans-serif;
  background:linear-gradient(270deg,#ff6a00,#ee0979,#ff6a00);
  background-size:600% 600%;
  animation:bg 18s ease infinite;
  color:#fff;
  min-height:100vh;
}
@keyframes bg{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
.container{
  max-width:520px;
  margin:auto;
  padding:20px;
}
h1{
  font-family:'Pacifico',cursive;
  text-align:center;
  font-size:3em;
}
.tabs{
  display:flex;
  gap:6px;
  justify-content:center;
  margin-bottom:12px;
}
.tabs button{
  flex:1;
  border:none;
  padding:8px;
  border-radius:20px;
  background:rgba(255,255,255,.2);
  color:#fff;
}
.tabs button.active{
  background:#fff;
  color:#ee0979;
}
select,button{
  width:100%;
  padding:12px;
  margin:6px 0;
  border-radius:12px;
  border:none;
  font-size:1em;
}
button{
  background:#fff;
  color:#ee0979;
  font-weight:600;
}
.card{
  background:rgba(0,0,0,.28);
  padding:12px;
  border-radius:14px;
  margin-top:12px;
}
.bar{
  height:8px;
  border-radius:6px;
  background:rgba(255,255,255,.2);
  overflow:hidden;
  margin:4px 0 10px;
}
.bar span{
  display:block;
  height:100%;
  background:#fff;
}
footer{
  text-align:center;
  font-family:'Pacifico',cursive;
  margin-top:28px;
}
.small{
  font-size:.85em;
  opacity:.85;
}
</style>
</head>

<body>
<div class="container">

<h1>CoDrive</h1>

<div class="tabs" id="tabs"></div>

<select id="from"></select>
<select id="to"></select>
<select id="time"></select>

<button onclick="submitRoute()">Select Route</button>

<div id="summary" class="card"></div>
<div id="results"></div>

<footer>Created by Animesh</footer>

</div>

<script>
const API="https://codrive-api.animesh-him.workers.dev";
let currentDate="";

async function loadLocations(){
  const [fromRes,toRes]=await Promise.all([
    fetch("from_locations.json"),
    fetch("to_locations.json")
  ]);
  const fromData=await fromRes.json();
  const toData=await toRes.json();

  const from=document.getElementById("from");
  const to=document.getElementById("to");

  from.innerHTML="";
  to.innerHTML='<option value="">Select Destination</option>';

  fromData.forEach(x=>{
    const o=document.createElement("option");
    o.textContent=o.value=x;
    from.appendChild(o);
  });

  toData.forEach(x=>{
    const o=document.createElement("option");
    o.textContent=o.value=x;
    to.appendChild(o);
  });
}

function genDates(){
  const tabs=document.getElementById("tabs");
  for(let i=0;i<6;i++){
    const d=new Date();
    d.setDate(d.getDate()-i);
    const val=d.toISOString().slice(0,10);
    const b=document.createElement("button");
    b.textContent=i===0?"Today":i===1?"Yesterday":val;
    b.onclick=()=>selectDate(val,b);
    if(i===0){b.classList.add("active");currentDate=val;}
    tabs.appendChild(b);
  }
}
function selectDate(v,btn){
  currentDate=v;
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  loadData();
}
function genTimes(){
  const t=document.getElementById("time");
  for(let h=0;h<24;h++){
    for(let m=0;m<60;m+=15){
      const s=`${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
      const eM=(m+15)%60;
      const eH=h+Math.floor((m+15)/60);
      const e=`${String(eH).padStart(2,"0")}:${String(eM).padStart(2,"0")}`;
      const o=document.createElement("option");
      o.value=`${s}-${e}`;
      o.textContent=`${s} – ${e}`;
      t.appendChild(o);
    }
  }
}
function canVote(k){
  const last=localStorage.getItem(k);
  if(last && Date.now()-last<60000) return false;
  localStorage.setItem(k,Date.now());
  return true;
}
async function submitRoute(){
  const payload={
    date:currentDate,
    from:from.value,
    to:to.value,
    time:time.value
  };
  const key=JSON.stringify(payload);
  if(!canVote(key)) return alert("Please wait a minute.");
  await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
  loadData();
}
async function loadData(){
  const res=await fetch(`${API}?date=${currentDate}`);
  const data=await res.json();
  const box=document.getElementById("results");
  const sum=document.getElementById("summary");
  box.innerHTML="";
  sum.innerHTML="";
  if(!data.length){sum.textContent="No selections yet.";return;}
  const routes={};
  data.forEach(d=>{
    const k=`${d.from} → ${d.to}`;
    routes[k]=routes[k]||[];
    routes[k].push(d);
  });
  const popular=Object.entries(routes).sort((a,b)=>b[1].reduce((s,x)=>s+x.count,0)-a[1].reduce((s,x)=>s+x.count,0))[0];
  sum.innerHTML=`<b>Popular today:</b><br>${popular[0]}`;
  Object.keys(routes).forEach(k=>{
    const arr=routes[k].sort((a,b)=>b.count-a.count);
    const max=arr[0].count;
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`<b>${k}</b><br>`+arr.map(x=>`
      <div class="small">${x.time} — ${x.count}</div>
      <div class="bar"><span style="width:${(x.count/max)*100}%"></span></div>
    `).join("");
    box.appendChild(c);
  });
}

loadLocations();
genDates();
genTimes();
loadData();
setInterval(loadData,60000);
</script>

</body>
</html>
